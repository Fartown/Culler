# Culler 性能优化方案（执行版）

## 现象
- 切换文件夹卡顿明显
- 切换图片卡顿明显
- 网格切到单图模式卡顿明显

## 主要根因（按影响从大到小）
1. ContentView 在主线程上重复做全量过滤与排序（O(n) + O(n log n)），且每次视图刷新都会重算。
2. Sidebar 每次刷新重建文件夹树（URL 标准化/分组/递归/排序），成本高。
3. 网格视图在单图模式下仅隐藏未卸载，缩略图任务仍在后台继续跑。
4. 单图切换每次都会预加载左右邻居大图，快速切图时叠加解码与 IO。
5. 高频路径中频繁触发 fileURL/bookmark 解析，放大开销。

## 目标
- 切换文件夹/筛选/排序时，主线程不再出现明显停顿。
- 网格 -> 单图切换时，后台缩略图任务迅速收敛。
- 单图连续左右切换时保持更稳定的帧率。

## 改进方案（分级）

### P0（收益最大，风险低，优先做）
- 用条件渲染卸载非活动视图：从 ZStack+opacity 改为 if/else，单图模式下网格直接释放。
- 缓存 displayedPhotos：把全量 filter/sort 从 computed property 迁到可取消的后台 Task，仅在输入变化时更新。
- 缓存 folderNodes：把 buildTree 从 body 内移出，按需重建并回写。
- 降低路径处理成本：优先用 NSString 的 path 操作替代频繁的 URL standardizedFileURL。
- 降低邻居预加载压力：邻居预加载改为延迟触发/可取消/低优先级，或先预加载缩略图再预加载大图。

### P1（任务调度优化）
- ThumbnailService 支持取消 inflight 任务（例如 cancelAll/cancel(prefix)），切换 scope/进入单图时主动取消旧任务。
- AsyncThumbnailView 加入轻微延迟与取消检查，降低快速切换造成的“任务风暴”。

### P2（可选：数据模型层优化，收益更高但要评估迁移）
- Photo 持久化 directoryPath（或标准化后的 folderPathKey），导入/同步时一次性写入。
- 过滤时直接使用该字段，避免每次从 filePath 动态解析。
- 评估将过滤/排序下推到 SwiftData 查询层，减少内存端全量处理。

## 验证方式
- Instruments：Time Profiler（主线程热点）、SwiftUI（重绘/布局）、Allocations（对象抖动）、File Activity（IO 峰值）。
- 基准动作：
  - 切换文件夹（不同层级/含子文件夹开关）
  - 网格 -> 单图 -> 返回网格
  - 单图模式连续左右切换 50 次

