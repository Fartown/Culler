## 问题根因概述
- 单图视图在进入后同时进行缩略图过渡、原图解码与邻居预加载，CPU/GPU 与磁盘 IO 压力叠加，导致切换动画与交互卡顿。[SinglePhotoView.swift:L241-L304](file:///Users/zhangchao/workspace/dev/Culler/Culler/Culler/Views/SinglePhotoView.swift#L241-L304)
- 网格返回时大量 cell 的缩略图任务同时启动（.task 绑定 photo.id），首次无缓存时形成“任务风暴”。[PhotoGridView.swift:L286-L392](file:///Users/zhangchao/workspace/dev/Culler/Culler/Culler/Views/PhotoGridView.swift#L286-L392)
- 首次进入或切换库范围时，ContentView 在主线程同步恢复安全范围权限，可能阻塞 UI。[ContentView.swift:L536-L552](file:///Users/zhangchao/workspace/dev/Culler/Culler/Culler/Views/ContentView.swift#L536-L552)

## 实施方案
### 1. 单图加载策略优化
- 动态降低原图解码尺寸：以容器对角线 × 屏幕 scale 作为上限，设硬上限 2048–3072 像素；仅在用户缩放超过 1.5x 后再升级更大尺寸。
- 过渡缩略图显示后延迟原图解码（例如 80–120ms），避免与切换动画、布局计算抢占主线程。
- 邻居预加载改为“交互空闲”触发：在滑动停止 150ms 后预加载左右各 1 张，并发限制为 1–2；正在显示的任务优先级最高。
- 任务去重与防抖：对同一 photo.id 的 displayImage 加载进行去重；若缓存命中则跳过解码。进入/返回时显式取消旧任务，保留已解码图像引用以复用。
- 修改位置：SinglePhotoView 的 loadFullImage 流程与邻居预加载逻辑。[SinglePhotoView.swift:L192-L304](file:///Users/zhangchao/workspace/dev/Culler/Culler/Culler/Views/SinglePhotoView.swift#L192-L304)

### 2. 缩略图任务调度与限速
- 引入 ThumbnailTaskQueue（服务层）：
  - 去重（按 photo.id + 目标尺寸），优先级（视口内 > 邻居 > 其他），并发上限（例如 4）。
  - Offscreen 取消：cell 移出视口立即取消对应任务。
- AsyncThumbnailView 改为通过队列提交任务，而不是每个 cell 直接开 Task.detached；网格快速滚动时视口内优先保证可见项。
- 调整 NSCache：依据内存压力设置 countLimit/totalCostLimit，缩略图与显示图分开管理。
- 修改位置：[PhotoGridView.swift:L286-L392](file:///Users/zhangchao/workspace/dev/Culler/Culler/Culler/Views/PhotoGridView.swift#L286-L392)、[ThumbnailService.swift:L23-L172](file:///Users/zhangchao/workspace/dev/Culler/Culler/Culler/Services/ThumbnailService.swift#L23-L172)

### 3. 主线程阻塞治理
- 将安全范围权限恢复迁移到后台：
  - 使用 Task.detached 或后台队列批量解析书签并 startAccessingSecurityScopedResource；通过 MainActor 汇总结果与错误。
  - 分批处理与惰性恢复：仅在访问到对应文件夹时恢复，避免启动阶段“一口气全做”。
- 修改位置：[ContentView.swift:L536-L552](file:///Users/zhangchao/workspace/dev/Culler/Culler/Culler/Views/ContentView.swift#L536-L552)

### 4. 视图切换与动画平滑
- 在 viewMode 切换时：先取消单图未完成的加载任务，然后触发状态切换，减少切换期间的资源竞争。[ContentView.swift:L268-L276](file:///Users/zhangchao/workspace/dev/Culler/Culler/Culler/Views/ContentView.swift#L268-L276)
- 使用 withAnimation/transaction 控制淡入与布局变更；避免在 onAppear 的同一帧启动重负载任务。

### 5. 性能监控与验证
- 为缩略图与显示图加载添加轻量指标：耗时、是否缓存命中、并发队列深度；在 Debug HUD 显示简要统计。
- 写 2 组基准：
  - 进入单图首帧时间（过渡缩略图呈现到稳定交互）。
  - 返回网格后首屏缩略图完成率与总耗时。
- 目标：进入/返回的交互响应 < 120ms；首屏缩略图完成 < 500ms（正常库）。

## 预期改动文件
- Views：SinglePhotoView.swift、PhotoGridView.swift、ContentView.swift
- Services：ThumbnailService.swift（新增 ThumbnailTaskQueue 或在现有服务中实现调度）

## 交付结果
- 更流畅的进入/返回单图体验；明显减少卡顿与掉帧。
- 受控的后台任务与更高缓存命中率；首次加载压力更低。
- 可量化的性能数据，便于后续迭代优化。