## 目标
- 为关键操作增加健壮的异常兜底：缩略图/大图加载、导入与文件同步、磁盘删除/移动、权限与安全书签。
- 提供一致的错误呈现：内联提示（Banner/Toast）、可交互的错误页（含重试/查看详情/在 Finder 显示/打开设置）。
- 统一错误类型与文案，便于记录与诊断，保证在 macOS 沙盒与安全书签场景下的可靠性。

## 覆盖场景
- 图像加载失败（文件缺失、权限失效、损坏/不支持格式、未知）。
  - 触点：缩略图与大图加载
  - 文件：[AsyncThumbnailView](file:///Users/zhangchao/workspace/dev/Culler/Culler/Culler/Views/PhotoGridView.swift#L334-L439)、[SinglePhotoView](file:///Users/zhangchao/workspace/dev/Culler/Culler/Culler/Views/SinglePhotoView.swift#L245-L312)、[ThumbnailService](file:///Users/zhangchao/workspace/dev/Culler/Culler/Culler/Services/ThumbnailService.swift)
- 导入与同步失败（源不可读、目标不可写、书签创建失败、重复）。
  - 触点：导入错误页、同步流程
  - 文件：[ImportErrorView](file:///Users/zhangchao/workspace/dev/Culler/Culler/Culler/Views/ImportErrorView.swift)、[ContentView](file:///Users/zhangchao/workspace/dev/Culler/Culler/Culler/Views/ContentView.swift)、[FolderSyncService](file:///Users/zhangchao/workspace/dev/Culler/Culler/Culler/Services/FolderSyncService.swift)
- 删除/移动磁盘文件失败（权限/不存在）。
  - 触点：右键菜单/快捷删除
  - 文件：[PhotoContextMenu](file:///Users/zhangchao/workspace/dev/Culler/Culler/Culler/Views/PhotoGridView.swift#L441-L596)、[SinglePhotoView](file:///Users/zhangchao/workspace/dev/Culler/Culler/Culler/Views/SinglePhotoView.swift#L344-L435)

## 统一错误模型
- 扩充并中文本地化 ImageLoadError 与 ImportProcessError，新增：ioError、bookmarkExpired、operationCancelled、diskFull、folderNotDirectory。
  - 文件：[AppErrors.swift](file:///Users/zhangchao/workspace/dev/Culler/Culler/Culler/Models/AppErrors.swift)
- 引入 ErrorDisplay 结构：包含标题、副标题、建议操作（重试/打开设置/在 Finder 显示/查看详情）。
- 建立 ErrorMapper：将服务层错误映射到 ErrorDisplay，集中管理文案与动作。

## 组件设计
- ErrorPageView（全屏错误页）：图标+标题+描述+操作按钮（重试、打开设置、在 Finder 显示、复制错误）。
- ErrorBannerView（顶部/底部内联 Banner）：用于非阻断提示，支持自动消失与“查看详情”。
- ErrorToast（轻量浮层）：用于短暂失败提示，如单项缩略图失败。

## 视图改造
- PhotoGridView
  - 在现有缩放 overlay 旁添加错误 Banner 容器；当批量加载失败比率超过阈值时显示。
  - 单格失败（AsyncThumbnailView.hasError）时展示可点击的警告图标：点击弹出 ErrorToast/详情。
  - 文件： [PhotoGridView.swift](file:///Users/zhangchao/workspace/dev/Culler/Culler/Culler/Views/PhotoGridView.swift)
- SinglePhotoView
  - 用 ErrorPageView 替换当前“无法加载图片”占位，增加“重试”“在 Finder 中显示”“打开设置（权限说明）”。
  - 在 crossfade/预加载失败时仍保持基本交互可用；错误状态下禁用缩放拖拽。
  - 文件： [SinglePhotoView.swift](file:///Users/zhangchao/workspace/dev/Culler/Culler/Culler/Views/SinglePhotoView.swift)
- ContentView（主容器）
  - 统一挂载 ErrorBannerView，关联同步/导入错误；“查看详情”打开 ImportErrorView（已有）。
  - 对 FolderSyncError：提供一键“重新选择文件夹”“清理安全书签”“打开偏好设置”入口。
  - 文件： [ContentView.swift](file:///Users/zhangchao/workspace/dev/Culler/Culler/Culler/Views/ContentView.swift)

## 服务层改造
- ThumbnailService
  - 对 startAccessingSecurityScopedResource 失败与文件不存在详细区分；生成/大图函数对 CGImageSource 失败增加原因捕获。
  - 在 Result.failure 中传递具体错误（bookmarkExpired/permissionDenied/fileNotFound/corruptedData/unsupportedFormat）。
  - 文件： [ThumbnailService.swift](file:///Users/zhangchao/workspace/dev/Culler/Culler/Culler/Services/ThumbnailService.swift)
- FolderSyncService
  - 同步前校验目标路径类型与可写性；当失败时返回 typed FolderSyncError（含本地化）。
  - 扩展错误：nonDirectory、noPermission、diskFull、bookmarkInvalid。
  - 文件： [FolderSyncService.swift](file:///Users/zhangchao/workspace/dev/Culler/Culler/Culler/Services/FolderSyncService.swift)

## 全局捕获与记录
- ErrorReporter（ObservableObject）：提供 publish(error:source:) API；在 ContentView 环境对象注入。
- 记录最近 N 次错误（时间、来源、文件路径），支持导出诊断（JSON）。
- 当出现未处理错误时，显示全局 Banner，并允许打开错误页。

## 交互与文案
- 统一简洁中文文案：
  - 文件缺失：该文件已移动或删除
  - 权限失效：应用无法访问该文件，请重新授权
  - 数据损坏：文件可能损坏或不受支持
  - 书签失效：请重新选择文件夹以续期访问权限
  - 磁盘不足：磁盘空间不足，清理后重试
- 操作按钮：重试、在 Finder 中显示、打开设置/重新选择文件夹、查看详情、复制错误。

## 验证与测试
- 单元测试：ErrorMapper 映射正确性；服务层返回错误分类。
- UI 测试：
  - 构造 fileNotFound/permissionDenied/corruptedData 场景，验证 AsyncThumbnailView 与 SinglePhotoView 的错误页显示与重试。
  - 导入重复/写入失败，验证 Banner 与 ImportErrorView 互通。
- 手动验证：安全书签续期流程与 macOS 沙盒权限路径。

## 交付物
- 新增：ErrorPageView.swift、ErrorBannerView.swift、ErrorToast.swift、ErrorMapper.swift、ErrorReporter.swift、ErrorDisplay.swift。
- 修改：PhotoGridView.swift、SinglePhotoView.swift、ContentView.swift、AppErrors.swift、ThumbnailService.swift、FolderSyncService.swift、ImportErrorView.swift（补充操作）。

## 实施方式
- 渐进引入：先完成模型与组件，再替换 SinglePhotoView/AsyncThumbnailView 的错误页与 Banner，最后串联 ContentView 全局捕获。
- 保持现有交互与视觉风格（颜色/圆角/过渡）一致；代码风格沿用项目当前模式（Result/Swift Concurrency/NSImage）。

确认后我将按以上方案分步实现，并在关键视图提供错误页与提示，确保所有异常都有可理解的兜底与操作。