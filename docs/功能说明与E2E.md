# Culler 功能说明与 E2E 覆盖

本文档用于：
- 详细描述当前已实现的功能（以代码/界面为准，不包含 PRD 中未落地的规划）。
- 为每个功能定义至少一个可执行的 E2E 用例（优先自动化）。
- 通过脚本统计“功能级 E2E 覆盖率”（覆盖率 = 有自动化 E2E 的功能数 / 功能总数）。
- 具体测试用例的实现方案详见：[E2E-测试用例实现说明](file:///Users/bytedance/workspace/ai-demo/culler/docs/E2E-测试用例实现说明.md)

## 1. 术语与约定

- **E2E**：端到端测试。对本项目来说，默认指 `XCUITest`（`CullerUITests`）驱动真实 UI。
- 备注：当前仓库未配置可运行的 `XCUITest` Target（Scheme 存在，但没有可测试的 bundle），因此本次 E2E 以 **App 内置自检** 的方式实现：启动参数 `-e2e` 会在 `ContentView` 内运行一组端到端场景并在失败时退出。
- **功能级覆盖率**：以本文件的“功能清单”为统计口径，不等同于代码行覆盖率。
- **用例命名**：`E2E-XX`，在测试代码中对应 `test_E2E_XX_*` 方法名。

## 2. 功能清单（现状）

> 统计脚本会读取本章节的表格作为覆盖口径，请不要随意改列名。

| 功能ID | 功能名称 | 当前行为（摘要） | E2E 用例 | 自动化 |
|---|---|---|---|---|
| F-01 | 启动与示例数据 | `-ui-testing` 启动时自动写入示例图片/相册/标签（若库为空） | E2E-01 | Yes |
| F-02 | 网格浏览 | 网格显示缩略图；支持点击选择、双击进入单图 | E2E-02 | Yes |
| F-03 | 单图查看 | 单图显示；左右切换；双击缩放；支持旋转按钮 | E2E-03 | Yes |
| F-04 | 标记工具栏 | 旗标(Pick/Reject/None)、评分(0-5)、颜色标签 | E2E-04 | Yes |
| F-05 | 筛选 | 侧栏筛选：旗标/评分/颜色；支持清除筛选 | E2E-05 | Yes |
| F-06 | 排序 | 顶部排序菜单：拍摄/导入/文件名/评分 | E2E-06 | Yes |
| F-07 | 导入 | 导入弹窗：选择文件/文件夹；引用/拷贝；去重；错误列表 | E2E-07 | Yes |
| F-08 | 文件夹同步 | 对当前文件夹执行同步：扫描新增/移除；完成后提示结果 | E2E-08 | Yes |
| F-09 | 相册与标签管理 | 管理弹窗：创建/删除相册；创建/删除标签；查看相册内容 | E2E-09 | Yes |
| F-10 | 检查器信息 | 右侧检查器展示：文件信息/拍摄信息/标记信息 | E2E-10 | Yes |
| F-11 | 视频识别与播放（含失败提示） | 以扩展名识别视频；单图显示播放器；不可播放时显示兜底提示 | E2E-11 | Yes |

## 3. E2E 用例设计（按功能）

### E2E-01 启动与示例数据
- 前置：用 `-ui-testing-reset` 清空库，再以 `-ui-testing` 启动。
- 断言：网格至少出现 1 个缩略图。

### E2E-02 网格浏览
- 操作：点击第 1 张缩略图；双击进入单图；返回网格。
- 断言：单图视图出现；返回后网格仍可见。

### E2E-03 单图查看
- 操作：进入单图；点击“下一张/上一张”；点击旋转按钮。
- 断言：序号文本变化；旋转按钮可点击且不崩溃。

### E2E-04 标记工具栏
- 操作：在单图下使用底部工具栏设置 Pick、5 星、红色标签。
- 断言：检查器“标记”区域出现“旗标/评分/颜色标签”字段。

### E2E-05 筛选
- 操作：设置评分筛选（>=3）；设置旗标筛选；清除筛选。
- 断言：顶部“张数”随筛选变化；清除后恢复为全量。

### E2E-06 排序
- 操作：打开排序菜单，依次切换“评分/文件名”。
- 断言：排序菜单显示当前选中的 shortTitle。

### E2E-07 导入
- 操作：打开导入弹窗；通过 UI 测试专用按钮生成一批新文件；选择“引用/拷贝”任一模式并开始导入。
- 断言：导入结束后返回主界面，顶部“张数”增加。

### E2E-08 文件夹同步
- 操作：选中示例图片所在文件夹；在磁盘创建 1 张新图片；点击“同步”。
- 断言：出现“同步完成”提示；顶部“张数”增加。

### E2E-09 相册与标签管理
- 操作：打开管理弹窗；创建相册；创建标签；删除刚创建的相册/标签。
- 断言：列表中可见新增项且可被删除。

### E2E-10 检查器信息
- 操作：进入单图，展开“信息/标记/文件”等区域（默认展开）。
- 断言：存在文件名、导入时间等字段；标记生效后显示对应字段。

### E2E-11 视频识别与播放（失败提示）
- 操作：在示例文件夹生成一个“不可播放但后缀为 mov/mp4”的文件；同步后进入该条目。
- 断言：单图视图出现“当前视频不可播放”兜底提示。

## 4. 覆盖率检查

### 4.1 功能级 E2E 覆盖率（必须）
- 执行：`python3 script/check_e2e_feature_coverage.py`
- 期望：覆盖率 `>= 90%`

### 4.2 运行 E2E（必须）
- 构建并运行：`bash script/run_e2e.sh`
- 或手动运行（示例）：`/path/to/Culler.app/Contents/MacOS/Culler -e2e`
> 注：`-e2e` 需要在有图形界面的 macOS 会话中运行（能正常显示窗口）；纯命令行/无 WindowServer 环境可能无法启动 UI。

### 4.3 代码覆盖率（可选）
如后续补齐 `XCUITest` Target，可以在 CI 里开启 Xcode 代码覆盖率：
- `xcodebuild test -scheme Culler -enableCodeCoverage YES`
- `xcrun xccov view --report <Test.xcresult>`
